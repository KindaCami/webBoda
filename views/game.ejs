<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â¿CuÃ¡nto los conoces? Â· Boda VÃ­ctor & Camilo</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.60.0/phaser.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background: #000; overflow: hidden;
            font-family: 'Orbitron', monospace; color: #fff;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            min-height: 100vh;
            background-image:
                radial-gradient(ellipse at 20% 30%, rgba(0,255,136,0.04) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 70%, rgba(0,136,255,0.04) 0%, transparent 50%);
        }
        #game-container { position: relative; }
        canvas { display: block; border-radius: 8px; }

        /* â”€â”€ RANKING OVERLAY â”€â”€ */
        #ranking-overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.92); backdrop-filter: blur(20px);
            z-index: 100; align-items: center; justify-content: center;
            flex-direction: column;
        }
        #ranking-overlay.open { display: flex; }
        .ranking-card {
            background: rgba(8,8,20,0.95); border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px; overflow: hidden;
            width: 90%; max-width: 480px;
            box-shadow: 0 0 60px rgba(0,255,136,0.1);
        }
        .ranking-accent { height: 3px; background: linear-gradient(90deg, #00ff88, #0088ff, #ff00cc); }
        .ranking-body { padding: 32px; }
        .ranking-title { font-size: 0.6rem; letter-spacing: 0.3em; color: #00ff88; margin-bottom: 8px; }
        .ranking-score { font-size: 3rem; font-weight: 900; color: #fff; margin-bottom: 4px; }
        .ranking-sub { font-size: 0.75rem; color: rgba(255,255,255,0.35); margin-bottom: 28px; }
        .ranking-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 24px; }
        .ranking-row {
            display: flex; align-items: center; gap: 12px;
            padding: 10px 14px; border-radius: 4px;
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05);
        }
        .ranking-row.me { background: rgba(0,255,136,0.07); border-color: rgba(0,255,136,0.2); }
        .ranking-pos { font-size: 0.65rem; font-weight: 700; color: rgba(255,255,255,0.3); width: 24px; }
        .ranking-pos.gold   { color: #ffd700; }
        .ranking-pos.silver { color: #c0c0c0; }
        .ranking-pos.bronze { color: #cd7f32; }
        .ranking-name { flex: 1; font-size: 0.8rem; color: #fff; }
        .ranking-pts { font-size: 0.75rem; color: #00ff88; font-weight: 700; }
        .ranking-actions { display: flex; gap: 10px; }
        .btn-ranking {
            flex: 1; padding: 12px; border-radius: 4px; border: none; cursor: pointer;
            font-family: 'Orbitron', monospace; font-size: 0.6rem; font-weight: 700;
            letter-spacing: 0.15em; text-transform: uppercase; transition: background 0.2s;
        }
        .btn-play-again { background: #00ff88; color: #000; }
        .btn-play-again:hover { background: #33ffaa; }
        .btn-home { background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.5); border: 1px solid rgba(255,255,255,0.1); }
        .btn-home:hover { color: #fff; }

        /* â”€â”€ FORMULARIO NOMBRE â”€â”€ */
        #name-overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.92); backdrop-filter: blur(20px);
            z-index: 100; align-items: center; justify-content: center;
        }
        #name-overlay.open { display: flex; }
        .name-card {
            background: rgba(8,8,20,0.95); border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px; overflow: hidden; width: 90%; max-width: 400px;
        }
        .name-body { padding: 32px; }
        .name-title { font-size: 0.6rem; letter-spacing: 0.3em; color: #00ff88; margin-bottom: 12px; }
        .name-h { font-size: 1.4rem; font-weight: 900; color: #fff; margin-bottom: 6px; }
        .name-sub { font-size: 0.8rem; color: rgba(255,255,255,0.35); margin-bottom: 24px; font-family: 'Inter', sans-serif; }
        .name-input {
            width: 100%; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 4px; padding: 12px 16px; color: #fff;
            font-family: 'Orbitron', monospace; font-size: 0.9rem; outline: none;
            margin-bottom: 16px; transition: border-color 0.2s;
        }
        .name-input:focus { border-color: rgba(0,255,136,0.4); }
        .name-input::placeholder { color: rgba(255,255,255,0.2); font-size: 0.75rem; }
        .btn-start {
            width: 100%; padding: 14px; background: #00ff88; color: #000;
            font-family: 'Orbitron', monospace; font-size: 0.7rem; font-weight: 700;
            letter-spacing: 0.2em; text-transform: uppercase; border: none; border-radius: 4px;
            cursor: pointer; transition: background 0.2s;
        }
        .btn-start:hover { background: #33ffaa; }
    </style>
</head>
<body>

<!-- SELECTOR DE INVITADO -->
<div id="name-overlay" class="open">
    <div class="name-card">
        <div class="ranking-accent"></div>
        <div class="name-body">
            <div class="name-title">âœ¦ MINIJUEGO Â· BODA 2026/2027</div>
            <div class="name-h">Tu conocimiento sobre los novios tiene premio</div>
            <p class="name-sub">10 preguntas sobre VÃ­ctor y Camilo. Vidas limitadas, tiempo por pregunta y ranking entre todos los invitados. <strong style="color:#ff00cc">Solo una partida por persona.</strong></p>

            <label class="field-label" style="display:block; font-family:'Orbitron',monospace; font-size:0.55rem; letter-spacing:0.18em; color:rgba(255,255,255,0.3); text-transform:uppercase; margin-bottom:8px;">Â¿QuiÃ©n juega?</label>
            <div id="member-selector" style="display:flex; flex-direction:column; gap:8px; margin-bottom:16px;">
                <% members.forEach(m => { %>
                <button class="member-btn" data-id="<%= m.id %>" data-name="<%= m.fullname %>" onclick="seleccionarInvitado(this)"
                    style="background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.1); border-radius:4px; padding:12px 16px; color:rgba(255,255,255,0.7); font-family:'Orbitron',monospace; font-size:0.7rem; letter-spacing:0.1em; cursor:pointer; text-align:left; transition:all 0.2s;">
                    ğŸ‘¤ <%= m.fullname %>
                </button>
                <% }); %>
            </div>

            <div id="ya-jugo-msg" style="display:none; background:rgba(255,165,0,0.08); border:1px solid rgba(255,165,0,0.2); border-left:3px solid #ffa500; border-radius:3px; padding:12px 16px; font-size:0.8rem; color:#ffa500; margin-bottom:12px; line-height:1.5;">
                âš  Esta persona ya ha jugado. Selecciona otro miembro del grupo.
            </div>

            <button class="btn-start" id="btn-empezar" onclick="startGame()" disabled style="opacity:0.4; cursor:not-allowed;">
                Selecciona quiÃ©n juega â†’
            </button>
        </div>
    </div>
</div>
<audio id="victory-audio" src="/audio/zeldaopening.mp3" preload="auto"></audio>

<!-- RANKING FINAL -->
<div id="ranking-overlay">
    <div class="ranking-card">
        <div class="ranking-accent"></div>
        <div class="ranking-body">
            <div class="ranking-title">âœ¦ PARTIDA TERMINADA</div>
            <div class="ranking-score" id="final-score">0</div>
            <div class="ranking-sub" id="final-msg">puntos conseguidos</div>
            <div class="ranking-list" id="ranking-list"></div>
            <div class="ranking-actions">
                <a href="/dashboard" class="btn-ranking btn-home" style="text-decoration:none;text-align:center;display:flex;align-items:center;justify-content:center;">â† Volver al panel</a>
            </div>
        </div>
    </div>
</div>

<div id="game-container"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PREGUNTAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PREGUNTAS = [
    {
        texto: "Â¿DÃ³nde se conocieron VÃ­ctor y Camilo?",
        opciones: ["Sol", "Moncloa", "Gran VÃ­a", "Retiro"],
        correcta: 1
    },
    {
        texto: "Â¿A quÃ© restaurante fueron en su primera cita?",
        opciones: ["Kagura", "Tierra Burrito", "Un sitio de Gyozas", "SUMO"],
        correcta: 1
    },
    {
        texto: "Â¿En quÃ© aÃ±o se conocieron VÃ­ctor y Camilo?",
        opciones: ["2021", "COVID", "2022", "2023"],
        correcta: 2
    },
    {
        texto: "Â¿DÃ³nde le pidiÃ³ VÃ­ctor matrimonio a Camilo?",
        opciones: ["En el Retiro de Madrid", "En la cima del Vesubio", "En la cima del Teide", "Kerepakupai VenÃ¡"],
        correcta: 1
    },
    {
        texto: "Â¿QuÃ© fecha fue la propuesta de matrimonio?",
        opciones: ["14 de febrero de 2024", "15 de mayo de 2024", "22 de mayo de 2024", "1 de enero de 2024"],
        correcta: 1
    },
    {
        texto: "Â¿DÃ³nde celebraron su rito celta?",
        opciones: ["Santiago de Compostela", "Lagoa San MartiÃ±o", "Cabo Fisterra", "RÃ­as Baixas"],
        correcta: 1
    },
    {
        texto: "Â¿De dÃ³nde es Camilo?",
        opciones: ["Miranda, Venezuela", "Anzoategui, Venezuela", "Sucre, Venezuela", "Caracas, Venezuela"],
        correcta: 2
    },
    {
        texto: "Â¿A quÃ© se dedica VÃ­ctor?",
        opciones: ["Arquitecto", "Ingeniero aeroespacial", "DJ", "Desarrollador de software"],
        correcta: 1
    },
    {
        texto: "Â¿CuÃ¡l es el spacecraft favorito de ambos?",
        opciones: ["Apolo 11", "Voyager II", "Space Shuttle", "ISS"],
        correcta: 1
    },
    {
        texto: "Â¿CuÃ¡l fue el planeta favorito de ambos en su infancia?",
        opciones: ["Saturno", "Marte", "Neptuno", "JÃºpiter"],
        correcta: 3
    },
    {
        texto: "Â¿CuÃ¡l es el planeta favorito de ambos ahora?",
        opciones: ["Marte", "Saturno", "La Tierra", "JÃºpiter"],
        correcta: 2
    },
    {
        texto: "Â¿CuÃ¡l es el videojuego favorito de VÃ­ctor?",
        opciones: ["The Legend of Zelda: Ocarina of Time", "Age of Empires II", "Cyberpunk 2077", "The Witcher 3"],
        correcta: 0
    },
    {
        texto: "Â¿CuÃ¡l es la saga favorita de videojuegos de Camilo?",
        opciones: ["Super Mario", "Grand Theft Auto", "Assassin's Creed", "Battlefront II"],
        correcta: 2
    },
    {
        texto: "Playa o montaÃ±a: Â¿quÃ© prefiere VÃ­ctor?",
        opciones: ["Playa", "MontaÃ±a", "Los dos igual", "Desierto"],
        correcta: 1
    },
    {
        texto: "Â¿QuiÃ©n es mÃ¡s probable que pierda el mÃ³vil?",
        opciones: ["VÃ­ctor", "Camilo", "Los dos igual", "Ninguno"],
        correcta: 1
    },
    {
        texto: "Â¿QuiÃ©n se queda dormido viendo una peli?",
        opciones: ["Camilo", "VÃ­ctor", "Los dos", "Ninguno"],
        correcta: 1
    },
    {
        texto: "Â¿QuiÃ©n dio el primer beso?",
        opciones: ["VÃ­ctor", "Camilo", "Fue simultÃ¡neo", "No lo saben"],
        correcta: 1
    },
    {
        texto: "Â¿QuiÃ©n ordena mejor la casa?",
        opciones: ["Camilo", "VÃ­ctor", "Los dos igual", "Ninguno"],
        correcta: 1
    },
    {
        texto: "Â¿QuiÃ©n cocina mejor?",
        opciones: ["VÃ­ctor", "Camilo", "Â¡Los dos!", "Ninguno"],
        correcta: 2
    },
    {
        texto: "Â¿QuiÃ©n es omnivertido?",
        opciones: ["Camilo", "VÃ­ctor", "Los dos igual", "Depende del dÃ­a"],
        correcta: 0
    },
    {
        texto: "Â¿QuiÃ©n tiene la familia mÃ¡s grande?",
        opciones: ["VÃ­ctor", "Camilo", "Son iguales", "No tienen familia"],
        correcta: 1
    },
    {
        // PREGUNTA TRAMPA
        texto: "Â¿QuiÃ©n es mÃ¡s demandante? (pregunta trampa, mira las opciones)",
        opciones: ["VÃ­ctor", "Camilo", "Sioux ğŸ¶", "Ninguno"],
        correcta: 2,
        trampa: true,
        descalificacion: [0, 1]
    }
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ESTADO GLOBAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let selectedGuestId = null;
let playerName = '';
let gameInstance = null;
let finalScore = 0;

async function seleccionarInvitado(btn) {
    // Resetear botones
    document.querySelectorAll('.member-btn').forEach(b => {
        b.style.background = 'rgba(255,255,255,0.04)';
        b.style.borderColor = 'rgba(255,255,255,0.1)';
        b.style.color = 'rgba(255,255,255,0.7)';
    });

    const guestId = btn.dataset.id;
    const guestName = btn.dataset.name;
    document.getElementById('ya-jugo-msg').style.display = 'none';

    // Comprobar si ya jugÃ³
    const res = await fetch(`/game/check/${guestId}`);
    const data = await res.json();

    if (data.yaJugo) {
        btn.style.background = 'rgba(255,165,0,0.08)';
        btn.style.borderColor = 'rgba(255,165,0,0.3)';
        btn.style.color = '#ffa500';
        document.getElementById('ya-jugo-msg').style.display = 'block';
        document.getElementById('btn-empezar').disabled = true;
        document.getElementById('btn-empezar').style.opacity = '0.4';
        document.getElementById('btn-empezar').style.cursor = 'not-allowed';
        document.getElementById('btn-empezar').textContent = 'Esta persona ya jugÃ³ â†’';
        selectedGuestId = null;
    } else {
        btn.style.background = 'rgba(0,255,136,0.08)';
        btn.style.borderColor = 'rgba(0,255,136,0.3)';
        btn.style.color = '#00ff88';
        selectedGuestId = guestId;
        playerName = guestName;
        document.getElementById('btn-empezar').disabled = false;
        document.getElementById('btn-empezar').style.opacity = '1';
        document.getElementById('btn-empezar').style.cursor = 'pointer';
        document.getElementById('btn-empezar').textContent = `Â¡A jugar, ${guestName.split(' ')[0]}! â†’`;
    }
}

function startGame() {
    if (!selectedGuestId) return;
    document.getElementById('name-overlay').classList.remove('open');
    initPhaser();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PHASER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initPhaser() {
    const W = Math.min(window.innerWidth, 700);
    const H = Math.min(window.innerHeight, 600);

    gameInstance = new Phaser.Game({
        type: Phaser.AUTO,
        width: W, height: H,
        backgroundColor: '#000000',
        parent: 'game-container',
        scene: { preload, create, update }
    });
}

// â”€â”€ Variables de escena â”€â”€
let preguntas, preguntaIdx, score, vidas, multiplicador, rachaCorrectas;
let timerVal, timerMax;
let textoQ, textosOpc, barraTimer, textoScore, textoVidas, textoMulti;
let stars = [], particles = [];
let estado; // 'intro' | 'pregunta' | 'feedback' | 'fin'
let feedbackTimer = 0;
let countdownVal = 3;
let countdownTimer = 0;
let countdownTxt;
let shakeTween;

function preload() {}

function create() {
    const W = this.scale.width;
    const H = this.scale.height;

    // Fondo estrellado
    stars = [];
    for (let i = 0; i < 120; i++) {
        const x = Phaser.Math.Between(0, W);
        const y = Phaser.Math.Between(0, H);
        const r = Math.random() * 1.5 + 0.3;
        const alpha = Math.random() * 0.6 + 0.2;
        const s = this.add.circle(x, y, r, 0xffffff, alpha);
        stars.push({ obj: s, speed: Math.random() * 0.3 + 0.05 });
    }

    // Estado inicial
    estado = 'intro';
    preguntas = Phaser.Utils.Array.Shuffle([...PREGUNTAS]).slice(0, 10);
    preguntaIdx = 0;
    score = 0;
    vidas = 3;
    multiplicador = 1;
    rachaCorrectas = 0;
    timerMax = 10;
    timerVal = timerMax;

    // â”€â”€ HUD â”€â”€
    const hudY = 20;

    // Score
    textoScore = this.add.text(16, hudY, 'SCORE: 0', {
        fontFamily: 'Orbitron', fontSize: '13px', color: '#00ff88',
        fontStyle: 'bold'
    });

    // Vidas
    textoVidas = this.add.text(W / 2, hudY, 'â¤ï¸ â¤ï¸ â¤ï¸', {
        fontFamily: 'Orbitron', fontSize: '14px', color: '#ff4444'
    }).setOrigin(0.5, 0);

    // Multiplicador
    textoMulti = this.add.text(W - 16, hudY, 'x1', {
        fontFamily: 'Orbitron', fontSize: '13px', color: '#ffd700', fontStyle: 'bold'
    }).setOrigin(1, 0);

    // Barra de tiempo
    this.add.rectangle(W / 2, 52, W - 32, 6, 0x111122).setOrigin(0.5);
    barraTimer = this.add.rectangle(16, 52, W - 32, 6, 0x00ff88).setOrigin(0, 0.5);

    // LÃ­nea separadora HUD
    this.add.rectangle(W / 2, 64, W, 1, 0xffffff, 0.06);

    // â”€â”€ PREGUNTA â”€â”€
    textoQ = this.add.text(W / 2, 100, '', {
        fontFamily: 'Orbitron', fontSize: '14px', color: '#ffffff',
        wordWrap: { width: W - 48 }, align: 'center', fontStyle: 'bold',
        lineSpacing: 6
    }).setOrigin(0.5, 0).setAlpha(0);

    // â”€â”€ OPCIONES â”€â”€
    textosOpc = [];
    const opcY = [200, 280, 360, 440];
    const scene = this;
    for (let i = 0; i < 4; i++) {
        const bg = this.add.rectangle(W / 2, opcY[i], W - 48, 56, 0x0d0d1a)
            .setStrokeStyle(1, 0x222244).setInteractive().setAlpha(0);
        const letraChar = ['A', 'B', 'C', 'D'][i];
        const letraT = this.add.text(W / 2 - (W - 48) / 2 + 20, opcY[i], letraChar, {
            fontFamily: 'Orbitron', fontSize: '12px', color: '#445566', fontStyle: 'bold'
        }).setOrigin(0, 0.5).setAlpha(0);
        const txt = this.add.text(W / 2 - (W - 48) / 2 + 44, opcY[i], '', {
            fontFamily: 'Inter', fontSize: '13px', color: '#cccccc',
            wordWrap: { width: W - 48 - 60 }
        }).setOrigin(0, 0.5).setAlpha(0);

        const idx = i;
        bg.on('pointerover', () => { if (estado === 'pregunta') bg.setFillStyle(0x111133); });
        bg.on('pointerout',  () => { if (estado === 'pregunta') bg.setFillStyle(0x0d0d1a); });
        bg.on('pointerdown', () => { if (estado === 'pregunta') seleccionarOpcion.call(scene, idx); });

        textosOpc.push({ bg, letra: letraT, txt });
    }

    // â”€â”€ NÃšMERO PREGUNTA â”€â”€
    this.numeroPregunta = this.add.text(W / 2, 78, '', {
        fontFamily: 'Orbitron', fontSize: '10px', color: 'rgba(255,255,255,0.3)',
        letterSpacing: 3
    }).setOrigin(0.5, 0).setAlpha(0);

    // â”€â”€ COUNTDOWN â”€â”€
    countdownTxt = this.add.text(W / 2, H / 2, '3', {
        fontFamily: 'Orbitron', fontSize: '80px', color: '#00ff88', fontStyle: 'bold'
    }).setOrigin(0.5).setAlpha(0);

    countdownVal = 3;
    countdownTimer = 0;
    mostrarCountdown.call(this);
}

function mostrarCountdown() {
    countdownTxt.setText(countdownVal.toString()).setAlpha(1).setScale(0.5);
    this.tweens.add({
        targets: countdownTxt,
        alpha: { from: 1, to: 0 },
        scale: { from: 1.5, to: 0.8 },
        duration: 800,
        ease: 'Power2'
    });
}

function mostrarPregunta() {
    const W = this.scale.width;
    const p = preguntas[preguntaIdx];
    estado = 'pregunta';
    timerVal = timerMax;

    // NÃºmero
    this.numeroPregunta.setText(`PREGUNTA ${preguntaIdx + 1} / ${preguntas.length}`).setAlpha(1);

    // Texto pregunta
    textoQ.setText(p.texto).setAlpha(0);
    this.tweens.add({ targets: textoQ, alpha: 1, duration: 300 });

    // Opciones
    for (let i = 0; i < 4; i++) {
        const opc = textosOpc[i];
        opc.bg.setFillStyle(0x0d0d1a).setStrokeStyle(1, 0x222244).setAlpha(0);
        opc.letra.setColor('#445566').setAlpha(0);
        opc.txt.setColor('#cccccc').setText(p.opciones[i]).setAlpha(0);
        this.tweens.add({ targets: [opc.bg, opc.letra, opc.txt], alpha: 1, duration: 300, delay: 100 + i * 60 });
    }
}

function seleccionarOpcion(idx) {
    if (estado !== 'pregunta') return;
    estado = 'feedback';
    feedbackTimer = 0;

    const p = preguntas[preguntaIdx];
    const correcta = p.correcta;
    const esCorrecta = idx === correcta;

    // â”€â”€ DESCALIFICACIÃ“N (pregunta trampa) â”€â”€
    if (p.trampa && p.descalificacion && p.descalificacion.includes(idx)) {
        // Resetear todas a neutro
        for (let i = 0; i < 4; i++) {
            textosOpc[i].bg.setFillStyle(0x0d0d1a).setStrokeStyle(1, 0x222244);
            textosOpc[i].txt.setColor('#888899');
            textosOpc[i].letra.setColor('#445566');
        }
        // Marcar en rojo la elegida
        textosOpc[idx].bg.setFillStyle(0x330000).setStrokeStyle(2, 0xff4444);
        textosOpc[idx].txt.setColor('#ff4444');
        textosOpc[idx].letra.setColor('#ff4444');
        // Mostrar la correcta
        textosOpc[correcta].bg.setFillStyle(0x003322).setStrokeStyle(2, 0x00ff88);
        textosOpc[correcta].txt.setColor('#00ff88');
        textosOpc[correcta].letra.setColor('#00ff88');

        this.cameras.main.shake(600, 0.015);
        showFloatingText.call(this, 'ğŸ’€ DESCALIFICADO', this.scale.width / 2, 160, '#ff4444');

        // Score a 0, terminar juego tras el feedback
        score = 0;
        vidas = 0;
        actualizarHUD.call(this);
        return;
    }

    // Resetear todas a neutro
    for (let i = 0; i < 4; i++) {
        textosOpc[i].bg.setFillStyle(0x0d0d1a).setStrokeStyle(1, 0x222244);
        textosOpc[i].txt.setColor('#888899');
        textosOpc[i].letra.setColor('#445566');
    }

    if (esCorrecta) {
        const pts = Math.round((100 + timerVal * 10) * multiplicador);
        score += pts;
        rachaCorrectas++;
        if (rachaCorrectas >= 3) multiplicador = Math.min(multiplicador + 1, 4);

        textosOpc[idx].bg.setFillStyle(0x003322).setStrokeStyle(2, 0x00ff88);
        textosOpc[idx].txt.setColor('#00ff88');
        textosOpc[idx].letra.setColor('#00ff88');
        spawnParticles.call(this, this.scale.width / 2, 300, 0x00ff88);
        showFloatingText.call(this, `+${pts}`, this.scale.width / 2, 170, '#00ff88');

        // Si la pregunta trampa tiene correcta == idx (Sioux) â€” bonus
        if (p.trampa) {
            showFloatingText.call(this, 'ğŸ¶ Â¡SIOUX GANA!', this.scale.width / 2, 130, '#ffd700');
        }

    } else {
        // Si es la trampa con Ninguno â€” pasar sin penalizaciÃ³n
        if (p.trampa && idx === 3) {
            textosOpc[idx].bg.setFillStyle(0x1a1a00).setStrokeStyle(1, 0x666600);
            textosOpc[idx].txt.setColor('#aaaa00');
            textosOpc[idx].letra.setColor('#aaaa00');
            textosOpc[correcta].bg.setFillStyle(0x003322).setStrokeStyle(2, 0x00ff88);
            textosOpc[correcta].txt.setColor('#00ff88');
            textosOpc[correcta].letra.setColor('#00ff88');
            showFloatingText.call(this, 'ğŸ¤” Hmmm... pasa', this.scale.width / 2, 170, '#aaaa00');
            actualizarHUD.call(this);
            // feedbackTimer ya estÃ¡ en 0 y estado en 'feedback', el update() avanzarÃ¡ solo
            return;
        }

        vidas--;
        rachaCorrectas = 0;
        multiplicador = 1;

        textosOpc[idx].bg.setFillStyle(0x330000).setStrokeStyle(2, 0xff4444);
        textosOpc[idx].txt.setColor('#ff4444');
        textosOpc[idx].letra.setColor('#ff4444');
        textosOpc[correcta].bg.setFillStyle(0x003322).setStrokeStyle(2, 0x00ff88);
        textosOpc[correcta].txt.setColor('#00ff88');
        textosOpc[correcta].letra.setColor('#00ff88');

        this.cameras.main.shake(300, 0.008);
        showFloatingText.call(this, 'âœ—', this.scale.width / 2, 170, '#ff4444');
    }

    actualizarHUD.call(this);
}

function actualizarHUD() {
    textoScore.setText(`SCORE: ${score.toLocaleString()}`);
    const corazones = 'â¤ï¸'.repeat(Math.max(0, vidas)) + 'ğŸ–¤'.repeat(Math.max(0, 3 - vidas));
    textoVidas.setText(corazones);
    textoMulti.setText(`x${multiplicador}`);
    textoMulti.setColor(multiplicador >= 3 ? '#ff00cc' : multiplicador >= 2 ? '#ffd700' : '#ffffff');
}

function showFloatingText(txt, x, y, color) {
    const t = this.add.text(x, y, txt, {
        fontFamily: 'Orbitron', fontSize: '22px', color, fontStyle: 'bold'
    }).setOrigin(0.5);
    this.tweens.add({
        targets: t, y: y - 60, alpha: 0, duration: 900,
        ease: 'Power2', onComplete: () => t.destroy()
    });
}

function spawnParticles(x, y, color) {
    for (let i = 0; i < 12; i++) {
        const p = this.add.circle(x, y, Phaser.Math.Between(3, 7), color, 1);
        const angle = Math.random() * Math.PI * 2;
        const speed = Math.random() * 160 + 60;
        this.tweens.add({
            targets: p,
            x: p.x + Math.cos(angle) * speed,
            y: p.y + Math.sin(angle) * speed,
            alpha: 0, scaleX: 0.1, scaleY: 0.1,
            duration: 600 + Math.random() * 300,
            ease: 'Power2',
            onComplete: () => p.destroy()
        });
    }
}

function siguientePregunta() {
    preguntaIdx++;
    if (preguntaIdx >= preguntas.length || vidas <= 0) {
        terminarJuego.call(this);
    } else {
        mostrarPregunta.call(this);
    }
}

function terminarJuego() {
    estado = 'fin';
    finalScore = score;
    guardarYMostrarRanking.call(this);
}

function lanzarCelebracionFinal(puntos) {
    const audio = document.getElementById('victory-audio');
    
    // 1. Configurar mÃºsica de Zelda
    audio.volume = 0.8; // Levemente fuerte
    audio.currentTime = 7; // Empezar en el segundo 7
    audio.play().catch(e => console.log("Audio bloqueado por el navegador:", e));

    // 2. Hacer que el asistente "diga" los puntos (Text-to-Speech)
    // Esperamos un poco para que entre la fanfarria de la mÃºsica
    setTimeout(() => {
        const mensaje = new SpeechSynthesisUtterance();
        mensaje.text = `Â¡IncreÃ­ble ${playerName.split(' ')[0]}! Has conseguido ${puntos} puntos.`;
        mensaje.lang = 'es-ES';
        mensaje.rate = 1; // Velocidad normal
        mensaje.pitch = 1; // Tono de voz
        window.speechSynthesis.speak(mensaje);
    }, 1500); // 1.5 segundos despuÃ©s de que empiece la mÃºsica
}

async function guardarYMostrarRanking() {
    try {
        const res = await fetch('/game/score', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ guest_id: selectedGuestId, player_name: playerName, score: finalScore })
        });
        const data = await res.json();
        if (data.ok === false && data.motivo) {
            console.warn(data.motivo);
        }
    } catch(e) { console.log('Error guardando score:', e); }

    // Obtener ranking
    let ranking = [];
    try {
        const res = await fetch('/game/ranking');
        ranking = await res.json();
    } catch(e) { ranking = []; }

    // Mostrar overlay
    document.getElementById('final-score').textContent = finalScore.toLocaleString();
    // LLAMADA A LA MÃšSICA Y VOZ
    lanzarCelebracionFinal(finalScore);
     const msgs = finalScore > 1500 ? 'Â¡Conoces a los novios mejor que ellos mismos! ğŸ†' :
                 finalScore > 800  ? 'Â¡Buen trabajo, se nota que los quieres! ğŸ’š' :
                 vidas <= 0        ? 'Sin vidas... Â¡vuelve a intentarlo! ğŸ’€' :
                                     'Â¡Sigue practicando para el dÃ­a de la boda! ğŸš€';
    document.getElementById('final-msg').textContent = msgs;

    const list = document.getElementById('ranking-list');
    list.innerHTML = '';
    const posClasses = ['gold', 'silver', 'bronze'];
    ranking.slice(0, 8).forEach((r, i) => {
        const isMe = r.player_name === playerName && r.score === finalScore;
        const div = document.createElement('div');
        div.className = `ranking-row${isMe ? ' me' : ''}`;
        const posClass = i < 3 ? posClasses[i] : '';
        const medal = i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : `#${i+1}`;
        div.innerHTML = `
            <span class="ranking-pos ${posClass}">${medal}</span>
            <span class="ranking-name">${r.player_name}${isMe ? ' (tÃº)' : ''}</span>
            <span class="ranking-pts">${parseInt(r.score).toLocaleString()} pts</span>
        `;
        list.appendChild(div);
    });

    document.getElementById('ranking-overlay').classList.add('open');
    if (gameInstance) { gameInstance.destroy(true); gameInstance = null; }
}

function update(time, delta) {
    const dt = delta / 1000;

    // Estrellas
    stars.forEach(s => {
        s.obj.y += s.speed;
        if (s.obj.y > this.scale.height) s.obj.y = 0;
    });

    if (estado === 'intro') {
        countdownTimer += dt;
        if (countdownTimer >= 1) {
            countdownTimer = 0;
            countdownVal--;
            if (countdownVal <= 0) {
                countdownTxt.setAlpha(0);
                estado = 'preguntando';
                mostrarPregunta.call(this);
            } else {
                mostrarCountdown.call(this);
            }
        }
        return;
    }

    if (estado === 'pregunta') {
        timerVal -= dt;
        if (timerVal <= 0) {
            timerVal = 0;
            // Tiempo agotado: mostrar respuesta correcta y restar vida
            estado = 'feedback';
            feedbackTimer = 0;
            vidas--;
            rachaCorrectas = 0;
            multiplicador = 1;
            const correcta = preguntas[preguntaIdx].correcta;
            textosOpc[correcta].bg.setFillStyle(0x003322).setStrokeStyle(2, 0x00ff88);
            textosOpc[correcta].txt.setColor('#00ff88');
            textosOpc[correcta].letra.setColor('#00ff88');
            showFloatingText.call(this, 'â± TIEMPO', this.scale.width / 2, 160, '#ffa500');
            this.cameras.main.shake(300, 0.006);
            actualizarHUD.call(this);
        }
        // Barra
        const W = this.scale.width;
        const pct = timerVal / timerMax;
        barraTimer.width = (W - 32) * pct;
        const col = timerVal > 6 ? 0x00ff88 : timerVal > 3 ? 0xffa500 : 0xff4444;
        barraTimer.setFillStyle(col);
        return;
    }

    if (estado === 'feedback') {
        feedbackTimer += dt;
        if (feedbackTimer >= 1.4) {
            // Ocultar opciones
            textosOpc.forEach(o => { o.bg.setAlpha(0); o.letra.setAlpha(0); o.txt.setAlpha(0); });
            textoQ.setAlpha(0);
            this.numeroPregunta.setAlpha(0);
            siguientePregunta.call(this);
        }
    }
}
</script>
</body>
</html>
